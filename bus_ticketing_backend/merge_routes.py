import csv
import io

def clean_name(name):
    # Fix common typos
    name = name.replace('KONDAPUAR TOECIL', 'KONDAPUR TO ECIL')
    name = name.replace('KONDAPUAR TO ECIL', 'KONDAPUR TO ECIL')
    name = name.replace('TOECIL', 'TO ECIL')
    name = name.replace('SEUNDERABAD', 'SECUNDERABAD')
    name = name.replace('MEHADIPATTANAM', 'MEHDIPATNAM')
    name = name.replace('MEHADIPATNAM', 'MEHDIPATNAM')
    name = name.replace('DAMMAIGUD', 'DAMMAYIGUDA')
    name = name.replace('ECILXROADS', 'ECIL X ROAD')
    name = name.replace('SEC BAD', 'SECUNDERABAD')
    name = name.replace('SECBAD', 'SECUNDERABAD')
    name = name.replace('MIYAOUR', 'MIYAPUR')
    name = name.replace('LINGAMPALLI', 'LINGAMPALLY')
    name = name.replace('SECENDRABAD', 'SECUNDERABAD')
    name = name.replace('SECUNDERBAD', 'SECUNDERABAD')
    name = name.replace('SECUNDRERABAD', 'SECUNDERABAD')
    name = name.replace('SECNDERABAD', 'SECUNDERABAD')
    name = name.replace('SEC BAD', 'SECUNDERABAD')
    name = name.replace('SECNDRBADBAD', 'SECUNDERABAD')
    name = name.replace('ECIL X ROADS', 'ECIL X ROAD')
    name = name.replace('ECIL X ROAD', 'ECIL X ROAD')
    name = name.replace('MIYAPUR2', 'MIYAPUR 2')
    name = name.replace('MIYAPUR1', 'MIYAPUR 1')
    return name.strip()

def merge_routes(existing_file, new_data_str):
    existing_routes = {}
    with open(existing_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        header = next(reader)
        for row in reader:
            if row:
                # Use route_id as key
                existing_routes[row[1]] = [row[0], row[1], clean_name(row[2])]

    new_reader = csv.reader(io.StringIO(new_data_str.strip()))
    new_header = next(new_reader) # skip header
    
    updated_count = 0
    added_count = 0
    
    for row in new_reader:
        if not row: continue
        route_name = row[0].strip()
        route_id = row[1].strip()
        origin_dest = clean_name(row[2])
        
        if route_id in existing_routes:
            if existing_routes[route_id][2] != origin_dest or existing_routes[route_id][0] != route_name:
                existing_routes[route_id] = [route_name, route_id, origin_dest]
                updated_count += 1
        else:
            existing_routes[route_id] = [route_name, route_id, origin_dest]
            added_count += 1
            
    # Sort by route_name or route_id? Let's keep it mostly as is or sort by route_id
    # Actually, sorting by route_id as integers if possible
    sorted_ids = sorted(existing_routes.keys(), key=lambda x: int(x) if x.isdigit() else 999999)
    
    with open(existing_file, 'w', encoding='utf-8', newline='') as f:
        writer = csv.writer(f)
        writer.writerow(['route', 'route_id', 'origin_destination'])
        for rid in sorted_ids:
            writer.writerow(existing_routes[rid])
            
    print(f"Updated {updated_count} routes.")
    print(f"Added {added_count} new routes.")

user_input_data = """route,route_id,origin_destination 
 1C,1438,CBS TO SECUNDERABAD 
 1C,1440,SECUNDERABAD TO CBS 
 1D,1005,CHILKALGUDA TO DILSUKH NAGAR 
 1DS,1441,MIDANI DEPOT TO SECUNDERABAD 
 1DS,1442,SECUNDERABAD TO MIDANI DEPOT 
 1DV,480,NGOS TO RETHI FILE BS 
 1DV,481,RETHIFILE TO NGOS COLONY 
 1P/251,788,MSRD 2 TO OLD ALWAL 
 1P/251,1416,OLD ALWAL TO MSRD 2 
 1P/25I,722,OLD ALWAL TO MGBS 
 1P/25I,723,MGBS TO OLDALWAL 
 1P/25S,1080,SUCHITRA TO KOTI 
 1P/25S,1081,KOTI TO SUCHITRA 
 1V,463,NGO COLONY TO RETHIFILE 
 1V,464,RETHIFILE TO NGOS COLONY 
 2C,231,BARKAS TO RETHIFILE BUSSTATION 
 2C,236,RETHIFILE BUSSTATION TO BARKAS 
 2Z,999,SRIRAM COLONY TO JBS 
 2Z,1000,JBS TO SRIRAM COLONY 
 3,1171,AFZULGUNJ TO RAJIVGRUHA KALPA 
 3,1192,RAJIVGRUHA KALPA TO AFZALGUNJ 
 3H,1172,AFZULGUNJ TO KUSHAIGUDA 
 3H,1173,KUSHAIGUDA TO AFZULGUNJ 
 3HN,1128,AFZULGUNJ TO RAMPALLY 
 3HN,1195,RAMPALLY TO AFZULGUNJ 
 3K,1426,KOTI TO KUSHAIGUDA 
 3K,1427,KUSHAIGUDA TO KOTI 
 3KN,406,KUSHAIGUDA TO AFZALGUNJ 
 3KN,407,AFZALGUNJ TO KUSHAIGUDA 
 5/229,1419,MEDCHAL TO MEHDIPATNAM 
 5/229,1421,MEHDIPATNAM TO MEDCHAL 
 5D,1228,DAMMAIGUD TO MEHADIPATTANAM 
 5K,371,MEHDIPATNAM TO SEUNDERABAD 
 5K,372,SECUNDERABAD TO MEHDIPATNAM 
 5K/251,1530,KEYS HIGH SCHOOL TO AIRPORT 
 5K/251,1531,AIRPORT TO KEYS HIGH SCHOOL 
 5K/92,997,RAJENDRANAGAR TO SECUNDERABAD 
 5K/92,1007,SECUNDERABAD TO RAJENDRANAGAR 
 5M,297,SECUNDERABAD TO MEHDIPATNAM 
 5M,299,MEHDIPATNAM TO SECUNDERABAD 
 5M/16M,1063,SECUNDERABAD TO MALKAJGIRI 
 5M/16M,1064,MEHDIPATNAM TO MALKAJGIRI 
 5R,212,HAKIMPET DEPOT TO MEHDIPATAM 
 5R,1082,MEHDIPATNAM TO HAKIMPET DEPOT 
 5S,1227,MEHADIPATNAM TO DAMMAYIGUDA 
 6H,1166,ECILXROADS TO TOLICHOWKI 
 6H,1186,TOLICHOWKI TO ECILXROADS 
 8A,918,FALKUNAMA TO SECUNDERABAD 
 8A,922,SECUNDERABAD TO FALKUNAMA DEPO 
 8C,1342,SECBAD TO CHANDRAYANAGUTTA 
 8C,1344,CHANDRAYANA GUTTA  TO SECBAD 
 8R,217,CBS RISALABAZAR 
 8R,1086,RISALA BAZAR TO CBS 
 8R/25M,1153,INDRAGANDHI STATUE TO CBS 
 8R/25S,1105,SUCHITRA TO CBS 
 8X,1378,SEC BAD TO RANIGUNJ 
 8X,1386,RANIGUNJ TO SAFILGUDA 
 9C,913,CBS TO SANATH NAGAR 
 9C,920,SANATH NAGAR TO CBS 
 9K,157,JEEDIMETLA AFZALGUNJ 
 9K,159,AFZALGUNJ TO JEEDIMETLA 
 9K/272,1217,GANDIMAISAMMA TO CBS 
 9M,1233,CHANDRAYANA GUTTA TO SANATHNA 
 9M,1345,SANATHNAGAR TO CHANDRAYANA GUT 
 9X,110,JEEDIMETLA DEPOT TO CBS 
 9X,113,CBS TO JEEDIMETLA DEPOT 
 9X/230,128,DUNDIGAL VILLAGE TO CBS 
 9X/230,134,CBS TO DUNDIGAL 
 9X/230X,800,DUNDIGAL TO AFZULGUNJ 
 9YF,194,BORABANDA CHARMINAR 
 9YF,200,CHARMINAR TO BORABANDA 
 10,183,SECUNDERABAD TO SANATH NAGAR 
 10,184,SANATHNAGAR TO SECUNDERABAD 
 10/224,1256,MIYAOUR TO SECUNDERABAD 
 10/224,1258,SECUNDERABAD TO MIYAPUR DEPOT1 
 10F,196,BORABANDA TO SECUNDERABAD 
 10F,197,SECUNDERABAD TO BORABANDA 
 10H,151,SECUNDERABAD TO KONDAPUR 
 10H,152,KONDAPUR TO SECUNDERABAD 
 10H/16,1051,CGCL DEPOT TO FLAGSTONE 
 10H/16,1052,FLAGSTONE TO ECIL X ROAD 
 10H/16A,1183,KONDAPUR TO CGCL DEPOT 
 10H/16A,1185,KONDAPUR TO CHERLAPALLY 
 10H/17H,131,KONDAPUAR TOECIL X ROAD 
 10H/17H,1167,ECILXROADS TO KONDAPUR 
 10H/219,1252,SECUNDERABAD TO PATANCHERU 
 10H/219,1253,PATANCHERU TO SECUNDERABAD 
 10H/224,810,SECUNDERABAD TO MIYAPUR2 DEPOT 
 10H/25I,204,OLD ALWAL TO KONDAPUR 
 10H/25I,205,KONDAPUR TO OLD ALWAL 
 10H/25S,1134,SUCHITRA TO KONDAPUR 
 10H/25S,1135,KONDAPUR TO SUCHITRA 
 10H/A,897,LINGAMPALLY TO ALLWYN 
 10H/L,1246,SECUNDERABAD TO LINGAMPALLI 
 10H/L,1248,LINGAMPALLI TO SECUNDERBAD 
 10H/U,895,HCU MAIN GATE TO SECUNDERABAD 
 10H/W,1255,SECUNDERABAD TO WAVEROCK 
 10H/W,1257,WAVEROCK TO SECENDRABAD 
 10K,1341,KUKATPALLY TO SECUNDERABAD 
 10K,1376,SAFILGUDA TO KUKATPALLY 
 10KH,877,ALLWYN X ROAD TO MYTRIVANAM 
 10KH,878,MYTHRIVANAM TO ALLWYNXROAD 
 10KJ,129,JAGADGIRI GUTTA TO SECUNDERABA 
 10KJ,130,SECUNDERABAD TO JAGADGIRIGUTTA 
 10KM,812,SECUNDERABAD TO NIZAMPETXROADS 
 10KM,813,SECUNDERABADTOMALAYSIANTOWNSHI 
 10KM,839,NIZAMPET X ROAD TO SECUNDERABA 
 10L,409,KPHB IV TO SECUNDERABAD 
 10L,410,SECUNDERABAD TO KPHB 4TH PHASE 
 10YF,192,BORABANDA TO SECUNDERABAD 
 10YF,195,SECUNDERABAD TO BORABANDA 
 11W,1238,ESI TO WAVEWROCK 
 11W,1331,WAVE ROCK TO ESI 
 12,91,KONDAPUR TO RAMNAGAR GUNDU 
 12,92,RAMNAGAR TO KONDAPUR 
 12RM,341,RAMNAGAR TO VBIT PARK 
 16A,1065,SECUNDERABAD TO ECILXROADS 
 16A,1387,ECILXROADS TO SECUNDERABAD 
 16A/10H,1179,FLAG STONE TO CHERLAPALLY 
 16A/219,1332,ECIL X ROAD TO PATANCHERUVU 
 16A/219,1335,PATANCHERU TO ECIL X ROADS 
 16A/47L,1068,ECIL X ROAD TO WAVEROCK 
 16A/47L,1546,WAVEROCK TO ECIL X ROADS 
 16A/47V,1075,ECIL TO VBIT 
 16A/49M,896,MEHDIPATNAM TO ECIL X ROAD 
 16A/49M,901,ECIL X ROAD TO MEHDIPATNAM 
 16C/29R,1279,ECILXROADS TO APURUPA COLONY 
 16C/29R,1338,APURUPA COLONY TO ECILXROADS 
 16H,1542,ECIL X ROAD TO SECUNDERABAD 
 16H,1543,RETHIFILE TO ECIL X ROADS 
 16H/47L,1544,ECIL X ROADS TO WAVE ROCK 
 16H/47L,1545,WAVEROCK TO ECIL X ROAD 
 16H/47V,1550,ECIL X ROADS TO VBIT 
 16M,1551,MALKAJGIRI TO SECUNDERABAD 
 16M/5M,1552,MALKAJGIRI TO MEHDIPATNAM 
 17D,1204,DAMMAYIGUDA TO SECENDRABAD 
 17H,1221,CHERLAPALLY TO MEHDIPATNAM 
 17H,1229,MEHDIPATNAM TO CHERLAPALLY 
 17H/47LI,1066,ECIL X ROADS TO FLAG STONE 
 17H/49M,280,KUSHAIGUDA TO MEHDIPATNAM 
 17H/49M,282,MEHDIPATNAM TO KUSHAIGUDA 
 17HN,1188,ECIL X ROADS TO SECUNDERABAD 
 17HN,1547,SECUNDERABAD TO ECIL X ROAD 
 17HN/47LI,1548,FLAGSTONE TO ECIL X ROADS 
 17S,1203,SECNDERABAD TO DAMMAYIGUDA 
 18/30,270,UPPAL X ROAD TO JAGADGIRI GUTT 
 18/30,271,JAGADGIRIGUTTA UPPALXROAD 
 18C,1164,CHOWDARIGUDA TO JBS 
 18C,1181,JBS TO CHOWDARIGUDA 
 19/224,847,MEHDIPATNAM TO MIYAPUR DEPOT 1 
 19K,605,MEHDIPATNAM TO KPHB TEMPLESTOP 
 19K,606,KPHB TEMPLESTOP TO MEHDIPATNAM 
 19K/224,1495,KPHB COLONY TO MIYAPUR2 DEPOT 
 19K/288,1494,MIYAPUR 2 DEPOT TO BALAJITEMPL 
 19M,248,KPHB 4TH PHASE TO MEHDIPATANAM 
 19M,264,MEHDIPATANAM TO KPHB 4TH PHASE 
 19M/288,675,MIYAPUR 2 DEPOT TO MEHDIPATNAM 
 19M/288,1562,MIYAPUR 1 TO MEHDIPATNAM 
 20P,321,SECUNDERABAD TO AFZALGUNJ 
 20P,322,AFZALGUNJ TO SECUNDERABAD 
 20X/251,323,SECUNDERABAD TO RGI AIRPORT 
 20X/251,324,RGI AIRPOT TO RETHIFILE BSTN 
 21/107J,225,VENKATAPURAM TO SAROOR NAGAR 
 21/107J,227,SAROORNAGAR TO VENKATAPURAM 
 21/107S,1091,SAROOR NAGAR TO HAKIM"""

merge_routes('c:\\manikanta chary\\my_app\\bus_ticketing_backend\\route_ids.csv', user_input_data)
